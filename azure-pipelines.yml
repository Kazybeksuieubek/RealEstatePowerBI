trigger:
- main

stages:
- stage: Dev
  displayName: 'Deploy to Dev'
  jobs:
  - job: DeployDev
    displayName: 'Deploy Report to Dev Workspace'
    pool:
      name: PPAgent  # Use the self-hosted agent instead of 'vmImage'
    steps:
    - checkout: self
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          # Install Power BI PowerShell module if not already installed
          Install-Module -Name MicrosoftPowerBIMgmt -Scope CurrentUser -Force -AllowClobber

          # Log in to Power BI Service
          $tenantId = "b41b72d0-4e9f-4c26-8a69-f949f367c91d"
          $clientId = "786263df-9ecf-4ecd-b109-a8cefd1173e2"
          $clientSecret = "$(PowerBIClientSecret)"  # Stored as a secret variable in Azure DevOps
          
          Connect-PowerBIServiceAccount -ServicePrincipal -TenantId $tenantId -ClientId $clientId -ClientSecret $clientSecret

          # Deploy the report
          $workspaceId = "7af6f710-e8b3-4fd6-98a1-ad4844254733"  # Dev Workspace ID
          $reportPath = "$(System.DefaultWorkingDirectory)/Reports/RealEstateReportDev.pbix"
          $reportName = "Real Estate Report Dev"

          Write-Host "Deploying Power BI report..."
          New-PowerBIReport -WorkspaceId $workspaceId -Path $reportPath -Name $reportName
          Write-Host "Deployment to Dev completed successfully."

- stage: QA
  displayName: 'Deploy to QA'
  dependsOn: Dev
  condition: succeeded()
  jobs:
  - job: DeployQA
    displayName: 'Deploy Report to QA Workspace'
    pool:
      name: PPAgent  # Use the self-hosted agent
    steps:
    - checkout: self
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          # Install Power BI PowerShell module if not already installed
          Install-Module -Name MicrosoftPowerBIMgmt -Scope CurrentUser -Force -AllowClobber

          # Log in to Power BI Service
          $tenantId = "b41b72d0-4e9f-4c26-8a69-f949f367c91d"
          $clientId = "786263df-9ecf-4ecd-b109-a8cefd1173e2"
          $clientSecret = "$(PowerBIClientSecret)"  # Stored as a secret variable in Azure DevOps

          Connect-PowerBIServiceAccount -ServicePrincipal -TenantId $tenantId -ClientId $clientId -ClientSecret $clientSecret

          # Deploy the report
          $workspaceId = "8903b2fd-67f8-4191-b2c4-f9687ee3fd17"  # QA Workspace ID
          $reportPath = "$(System.DefaultWorkingDirectory)/Reports/RealEstateReportQA.pbix"
          $reportName = "Real Estate Report QA"

          Write-Host "Deploying Power BI report..."
          New-PowerBIReport -WorkspaceId $workspaceId -Path $reportPath -Name $reportName
          Write-Host "Deployment to QA completed successfully."

- stage: Prod
  displayName: 'Deploy to Prod'
  dependsOn: QA
  condition: succeeded()
  jobs:
  - job: DeployProd
    displayName: 'Deploy Report to Prod Workspace'
    pool:
      name: PPAgent  # Use the self-hosted agent
    steps:
    - checkout: self
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          # Install Power BI PowerShell module if not already installed
          Install-Module -Name MicrosoftPowerBIMgmt -Scope CurrentUser -Force -AllowClobber

          # Log in to Power BI Service
          $tenantId = "b41b72d0-4e9f-4c26-8a69-f949f367c91d"
          $clientId = "786263df-9ecf-4ecd-b109-a8cefd1173e2"
          $clientSecret = "$(PowerBIClientSecret)"  # Stored as a secret variable in Azure DevOps

          Connect-PowerBIServiceAccount -ServicePrincipal -TenantId $tenantId -ClientId $clientId -ClientSecret $clientSecret

          # Deploy the report
          $workspaceId = "9e99227a-0de6-4073-b18c-e55f85246632"  # Prod Workspace ID
          $reportPath = "$(System.DefaultWorkingDirectory)/Reports/RealEstateReportProd.pbix"
          $reportName = "Real Estate Report Prod"

          Write-Host "Deploying Power BI report..."
          New-PowerBIReport -WorkspaceId $workspaceId -Path $reportPath -Name $reportName
          Write-Host "Deployment to Prod completed successfully."
