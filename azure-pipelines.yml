trigger:
- main

stages:
- stage: Dev
  displayName: 'Deploy to Dev'
  jobs:
  - job: DeployDev
    displayName: 'Deploy Report to Dev Workspace'
    pool:
      name: PPAgent  # Using the self-hosted agent
    steps:
    - checkout: self
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "ðŸ”¹ Starting deployment to Dev..."

          # Install Power BI PowerShell module if not already installed
          Install-Module -Name MicrosoftPowerBIMgmt -Scope CurrentUser -Force -AllowClobber

          # Log in to Power BI Service using Interactive Authentication
          Write-Host "ðŸ”‘ Logging into Power BI..."
          Login-PowerBIServiceAccount

          # Deploy the report
          $workspaceId = "7af6f710-e8b3-4fd6-98a1-ad4844254733"  # Dev Workspace ID
          $reportPath = "$(Build.SourcesDirectory)/Reports/RealEstateReportDev.pbix"
          $reportName = "Real Estate Report Dev"

          Write-Host "ðŸ“¤ Deploying Power BI report to Dev..."
          New-PowerBIReport -WorkspaceId $workspaceId -Path $reportPath -Name $reportName
          Write-Host "âœ… Deployment to Dev completed successfully."

- stage: QA
  displayName: 'Deploy to QA'
  dependsOn: Dev
  condition: succeeded()
  jobs:
  - job: DeployQA
    displayName: 'Deploy Report to QA Workspace'
    pool:
      name: PPAgent  # Using the self-hosted agent
    steps:
    - checkout: self
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "ðŸ”¹ Starting deployment to QA..."

          # Install Power BI PowerShell module if not already installed
          Install-Module -Name MicrosoftPowerBIMgmt -Scope CurrentUser -Force -AllowClobber

          # Log in to Power BI Service using Interactive Authentication
          Write-Host "ðŸ”‘ Logging into Power BI..."
          Login-PowerBIServiceAccount

          # Deploy the report
          $workspaceId = "8903b2fd-67f8-4191-b2c4-f9687ee3fd17"  # QA Workspace ID
          $reportPath = "$(Build.SourcesDirectory)/Reports/RealEstateReportQA.pbix"
          $reportName = "Real Estate Report QA"

          Write-Host "ðŸ“¤ Deploying Power BI report to QA..."
          New-PowerBIReport -WorkspaceId $workspaceId -Path $reportPath -Name $reportName
          Write-Host "âœ… Deployment to QA completed successfully."

- stage: Prod
  displayName: 'Deploy to Prod'
  dependsOn: QA
  condition: succeeded()
  jobs:
  - job: DeployProd
    displayName: 'Deploy Report to Prod Workspace'
    pool:
      name: PPAgent  # Using the self-hosted agent
    steps:
    - checkout: self
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "ðŸ”¹ Starting deployment to Prod..."

          # Install Power BI PowerShell module if not already installed
          Install-Module -Name MicrosoftPowerBIMgmt -Scope CurrentUser -Force -AllowClobber

          # Log in to Power BI Service using Interactive Authentication
          Write-Host "ðŸ”‘ Logging into Power BI..."
          Login-PowerBIServiceAccount

          # Deploy the report
          $workspaceId = "9e99227a-0de6-4073-b18c-e55f85246632"  # Prod Workspace ID
          $reportPath = "$(Build.SourcesDirectory)/Reports/RealEstateReportProd.pbix"
          $reportName = "Real Estate Report Prod"

          Write-Host "ðŸ“¤ Deploying Power BI report to Prod..."
          New-PowerBIReport -WorkspaceId $workspaceId -Path $reportPath -Name $reportName
          Write-Host "âœ… Deployment to Prod completed successfully."
